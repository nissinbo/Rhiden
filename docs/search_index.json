[["index.html", "My R book 1 はじめに 1.1 What’s this? 1.2 作成・ビルド 1.3 公開 1.4 サンプルデータ", " My R book nissinbo 2021-02-10 17:55:42 1 はじめに 1.1 What’s this? Rに関する個人的メモ 便利だと思ったもの, 備忘録, 気になることなど 1.2 作成・ビルド bookdownパッケージを使用 チャンクラベルが重複しないように注意 BuildタブのBuild Bookをクリック 1.3 公開 githubで管理(したい) 1.4 サンプルデータ 3つのサンプルデータを使用 sample_patient.csv sample_drug.csv sample_disease.csv githubから直接読み込む "],["ディレクトリとr-project.html", "2 ディレクトリとR Project 2.1 作業ディレクトリ確認 2.2 作業ディレクトリ設定", " 2 ディレクトリとR Project ディレクトリの設定やR Projectについて記す 2.1 作業ディレクトリ確認 自分が今どこにいるか getwd() 2.2 作業ディレクトリ設定 setwd(&quot;./folder/path/here&quot;) Ctrl + Shift + HでGUIによる設定が可能 2.2.1 スクリプトファイルが存在するとこにsetwdしたい R Studioでのみ使用可 R Projectは使いたくないけど相対パスで管理したい場合は使える setwd(dirname(rstudioapi::getActiveDocumentContext()$path)) 2.2.2 R Project 1つの分析プロジェクトに対して1つのR Projectを作成する .Rprojのあるフォルダがディレクトリになる 2.2.3 here package Rproj等を起点にファイルパスの指定ができる Windows/Macの互換などを気にする必要がなくなる uriboさん "],["入力.html", "3 入力 3.1 CSvファイル読込 3.2 Excelから読込(xlsx) 3.3 SASデータから読込(sas7bdat)", " 3 入力 3.1 CSvファイル読込 3.1.1 read.csv df &lt;- read.csv(&quot;df.csv&quot;) 3.1.2 fread data.frameで読み込むためにはdata.table=FALSE library(data.table) df &lt;- fread(&quot;df.csv&quot;, sep = &quot;,&quot;, data.table = FALSE) 3.1.3 型や名前を明示的に指定して読み込み 読み込み時はこれを使ってやるのが一番安全 特に桁数の大きい患者ID等は必ずcharacterにする もっと簡単な方法がありそう data &lt;- fread(&quot;test.csv&quot;, colClasses = c(&quot;character&quot;, &quot;character&quot;, rep(&quot;numeric&quot;,3), &quot;character&quot;), col.names = c(&quot;c1&quot;, &quot;c2&quot;, &quot;c3&quot;, &quot;c4&quot;, &quot;c5&quot;, &quot;c6&quot;)) 3.2 Excelから読込(xlsx) openxlsx packageが気軽に使える データ型に注意 library(openxlsx) df &lt;- read.xlsx(&quot;df.xlsx&quot;) 3.3 SASデータから読込(sas7bdat) haven packageでSAS形式を直接読み取れる "],["データ確認.html", "4 データ確認 4.1 列ごと 4.2 dataframeの概要", " 4 データ確認 4.1 列ごと 4.1.1 欠損列を含む列を表示 starwars %&gt;% summarise(across(everything(), ~sum(is.na(.)), .names = &quot;{.col}_na&quot;)) 4.1.2 ユニークデータ数 df %&gt;% n_distinct(id) 4.1.3 列の型 mode, typeof starwars %&gt;% summarise(across(everything(), ~mode(.))) starwars %&gt;% summarise(across(everything(), ~typeof(.))) 4.1.4 列ごとに型、重複無し数、欠損数を表示 starwars %&gt;% map_df(~(data.frame(class = class(.x), n_distinct = n_distinct(.x), isna = sum(is.na(.x)))), .id = &quot;variable&quot;) 4.2 dataframeの概要 4.2.1 dataframeの次元(行数と列数) dim(data) 4.2.2 package summarytools::descr(), summarytools::dfSummary() skimr::skim() "],["データ編集.html", "5 データ編集 5.1 列の追加 5.2 列の編集 5.3 列の削除 5.4 列の選択 5.5 列の入替 5.6 列の名前変更 5.7 列名取得 5.8 並べ替え 5.9 条件によるフィルタ 5.10 重複削除 5.11 データを縦に結合 5.12 データを横に結合 5.13 マッチしたデータを横に結合 5.14 1行ずらす 5.15 文字列結合 5.16 文字列切り出し 5.17 正規表現 5.18 欠損値 5.19 穴埋め 5.20 除外 5.21 LOCF", " 5 データ編集 サンプルデータで実行例を示す 5.1 列の追加 5.1.1 mutate library(dplyr) df &lt;- mutate(df,hoge = huga + piyo) 5.1.2 add_column 指定の位置に列を追加 df %&gt;% add_column(new_var = c(&quot;あ&quot;, &quot;い&quot;, &quot;う&quot;), .before = &quot;my_var&quot;) 5.1.3 3つ以上の列から最大や最小を求める maxやminはデフォルトでは列方向にしか働かない df &lt;- df %&gt;% rowwise() %&gt;% mutate(abc_max = max(A, B, C)) 5.2 列の編集 5.2.1 mutate df &lt;- mutate(df,hoge = as.character(hoge)) 5.2.2 mutate, across 5.3 列の削除 df2 &lt;- select(df, -3, -5, -6) df3 &lt;- select(df, -piyo) 5.4 列の選択 df2 &lt;- select(df, 2, 3, 5) df2 &lt;- select(df, hoge, piyo) 5.4.1 列名が重複してる場合 列名が重複してるデータをもらった場合、select等で列名を指定することができない 下記のように片方の列を消すか、 df &lt;- df[, unique(colnames(df)), with = FALSE] 下記を使うと列名の重複を解消してくれる tibble::repair_names() 5.5 列の入替 df2 &lt;- select(df, 2, 3, 4, 1, 5) df2 &lt;- select(df, b, c, d, a, e) 5.6 列の名前変更 5.6.1 全体変更 df2 &lt;- set_colnames(df, c(&quot;hoge&quot;, &quot;piyo&quot;, &quot;hugahuga&quot;)) 5.6.2 一部変更 df2 &lt;- rename(df, piyopiyo = hoge) 5.7 列名取得 colnames(df) 5.8 並べ替え df2 &lt;- arrange(df, ID) 5.9 条件によるフィルタ df2 &lt;- filter(df, name == &quot;hoge&quot;) 5.9.1 その人のx番目の行を取得 5.9.1.1 row_number()を使う df2 &lt;- df %&gt;% group_by(id) %&gt;% filter(row_number() == 2) %&gt;% # ここの数字を変えてx番目の行を取得 ungroup() 5.9.1.2 top_n()を使う df2 &lt;- df %&gt;% group_by(ID) %&gt;% top_n(2, date) %&gt;% # ここの数字を変えてx番目の行を取得 ungroup() 5.9.2 あるベクトルに含まれる行を抽出 new_data &lt;- semi_join(data1, data2, &quot;ID&quot;) new_data &lt;- filter(data1, id %in% data2$ID) 5.9.3 あるベクトルに含まれない行を抽出 new_data &lt;- anti_join(data1, data2, &quot;ID&quot;) new_data &lt;- filter(data1, !(id %in% data2$ID)) 5.10 重複削除 5.10.1 distinct df2 &lt;- distinct(df, ID, .keep_all = TRUE) 5.10.2 first df2 &lt;- df %&gt;% group_by(id) %&gt;% first() %&gt;% ungroup() 5.11 データを縦に結合 以下の2つはほとんど同じ動きだが、列名が一致してないときとか違う挙動を示す? new_data &lt;- bind_rows(data1, data2, data3) new_data &lt;- rbind_all(data1, data2, data3) 5.12 データを横に結合 以下の2つはほとんど同じ動きだが、行数が一致してないときとか違う挙動を示す? new_data &lt;- bind_cols(data1, data2) new_data &lt;- cbind_all(data1, data2) 5.13 マッチしたデータを横に結合 参考文献 new_data &lt;- left_join(data1, data2, &quot;ID&quot;) new_data &lt;- inner_join(data1, data2, &quot;ID&quot;) 2つのデータで同じ名前の列があると接尾に「.x」と「.y」がつくがsuffixを使うと自分で指定できる inner_join(x, y, &quot;id&quot;, suffix = c(&quot;_original&quot;, &quot;_new&quot;)) 5.14 1行ずらす lag() lead() 5.14.1 case_when 変えたいものが3つ以上あるときは、case_whenを使うと便利。 様々な表現を年齢で統一したい… 上述のmutate（列の追加）と組み合わせればできます。 df &lt;- mutate(df,newage = case_when(age==&quot;高齢者&quot; ~ &quot;70歳代&quot;, age==&quot;成人&quot; ~ &quot;30歳代&quot;, age==&quot;乳幼児&quot; ~ &quot;10歳未満&quot;, age==&quot;小児&quot; ~ &quot;10歳未満&quot;, age==&quot;青少年&quot; ~ &quot;10歳代&quot;, TRUE ~age)) 5.14.2 str_replace_all(未編集) stringr::str_replace_allを使うといい感じ。 参考 5.15 文字列結合 pasteを使う。sepで区切り文字を指定する。 df$new_var &lt;- paste(df$ID,df$sex,sep = &quot;,&quot;) sepを指定しないと半角スペースになる。 paste0だと区切り文字なし df$new_var &lt;- paste0(df$ID,df$sex) 5.16 文字列切り出し substrを使う。参考文献 dna &lt;- c(&quot;AAGCT&quot;, &quot;TTAAA&quot;, &quot;CCTAT&quot;) substr(dna, 2, 3) 第2引数は切出しの開始位置、第3引数は終了位置を指定 5.17 正規表現 5.18 欠損値 簡単にはここに書いてあるよ。 5.19 穴埋め 5.19.1 基本 dplyrのif_elseを使う。 下の例は「もし欠損なら代入し、欠損でなければそのまま」という動き library(dplyr) df$hoge &lt;- if_else(is.na(df$hoge),&quot;ああ&quot;,df$hoge) デフォルトのifelse関数は絶対に使わないでね。参考文献 TRUEとFALSEでデータ型が一致してないとダメだから注意。 5.19.2 欠損を0で埋める df[is.na(df)] &lt;- 0 5.20 除外 欠損がある「行」を全て削除する。 つまりComplete Cases。 df2 &lt;- na.omit(df) 5.21 LOCF {tidyr}のfill()を使う。 df2 &lt;- df1 %&gt;% fill(age, value1) pull() mutate(bmigp = case_when(bmi &lt; 25 ~ 1, 25 &lt;= bmi &amp; bmi &lt; 30 ~ 2, 30 &lt;= bmi ~ 3)) mutate(bmigp=cut(bmi, c(0, 25, 30, 40), labels=c(“nwt”, “owt”, “obese”), LEFT =FALSE)) "],["ggplot2によるvisualization.html", "6 ggplot2によるVisualization 6.1 基本 6.2 応用 6.3 生存時間分析 6.4 便利なサイト", " 6 ggplot2によるVisualization 制作中です 6.1 基本 6.2 応用 6.2.1 図中にテキストラベルを入れる ggrepel(https://cran.r-project.org/web/packages/ggrepel/vignettes/ggrepel.html) 6.2.2 複数の図を並べる patchwork 6.3 生存時間分析 6.3.1 ggforest 6.3.2 Kaplan-Meier曲線 6.4 便利なサイト data to viz 手持ちのデータから、どのように視覚化するかを教えてくれる "],["統計解析.html", "7 統計解析 7.1 検定 7.2 回帰分析 7.3 生存時間分析", " 7 統計解析 制作中 inferパッケージのchisq_test()が便利。 tidy dataから、一発で検定できる。 library(infer) mtcars %&gt;% mutate(cyl = factor(cyl), am = factor(am)) %&gt;% chisq_test(cyl ~ am) 7.1 検定 7.1.1 t検定 7.1.2 Wilcoxonの順位和検定 {coin}のwilcox_test()を使おう。 参考文献 wilcox_test(number ~ group, data = df, distribution = &quot;exact&quot;) 7.1.3 分割表の検定 カイ二乗検定, フィッシャーの正確検定 7.2 回帰分析 7.2.1 重回帰 7.2.2 ロジスティック回帰 7.2.2.1 broom library(broom) tidy(model, conf.int = TRUE, exponentiate = TRUE) 7.3 生存時間分析 https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html 7.3.1 Cox回帰 {survival}と{survminer}を使う。 library(survival) library(survminer) cox &lt;- coxph(Surv(time, event) ~ group + sex + age, method = &quot;breslow&quot;, data = dat) ggforest(cox) "],["出力保存.html", "8 出力・保存 8.1 表を作る 8.2 RData, RDSで出力 8.3 csvで出力 8.4 xlsxで出力 8.5 結果の出力", " 8 出力・保存 作成中 8.1 表を作る 8.1.1 kable 8.1.2 DT 8.1.3 tableOne 8.1.4 gt, gsummary 8.1.5 flextable, ftExtra 8.2 RData, RDSで出力 複数のオブジェクトを1つのRDataに保存することも可能 RDataとRDSは微妙な違いがあるそう save(df, file = &quot;df.RData&quot;) save(df, file = &quot;df.rda&quot;) save(df1, df2, df3, file = &quot;df.RData&quot;) saveRDS(x, file=&quot;x.Rds&quot;) 8.3 csvで出力 8.3.1 デフォルト関数 write.csv(df, &quot;df.csv&quot;, row.names = F) 8.3.2 fwrite library(data.table) fwrite(df, &quot;df.csv&quot;) 8.4 xlsxで出力 library(openxlsx) write.xlsx(df, &quot;df.xlsx&quot;) 8.5 結果の出力 consoleの出力結果を保存する場合 8.5.1 sink sink()でリセットされる append = FALSEで上書き(デフォルト) TRUEで追記 sink(&quot;./result.txt&quot;, append = FALSE) print(1 + 1) sink() "],["自作関数.html", "9 自作関数 9.1 自作関数の作り方", " 9 自作関数 制作中 9.1 自作関数の作り方 NSE https://rlang.r-lib.org/reference/nse-force.html "],["r-markdown.html", "10 R Markdown 10.1 R Markdownの基本 10.2 Chunk Option 10.3 Rmdでのディレクトリ設定 10.4 knitの出力先指定", " 10 R Markdown 制作中 10.1 R Markdownの基本 クックブックook/ 10.2 Chunk Option 各Chunkごとに各種設定が行える 参考文献1 参考文献2 マイナーだが便利なオプション cache fig.width fig.height 10.2.1 Global Option Rmdファイル全体に適用したいoptionは、Global Optionとして設定できる。 opts_chunk$set(prompt = TRUE, message = FALSE) 10.3 Rmdでのディレクトリ設定 Rmdではsetwdをしてもチャンク毎にリセットされる。 ファイルでディレクトリを設定したい場合は、以下のように設定する。 opts_chunk$set(root.dir = &quot;/path/to/folder/&quot;) 10.4 knitの出力先指定 knit: (function(...) rmarkdown::render(..., output_file = &quot;./result.html&quot;, envir=.GlobalEnv)) "],["使用パッケージ.html", "11 使用パッケージ 11.1 必須 11.2 推奨", " 11 使用パッケージ 11.1 必須 11.1.1 全般 remotes usethis installr rstudioapi fs here eply MilesMcBain/breakerofchains 11.1.2 パッケージ管理 BiocManager pacman 11.1.3 データ分析 tidyverse openxlsx dummies data.table 11.1.4 統計解析 tidymodels survival survminer 11.1.5 表 tableone gt gtsummary DT flextable ftExtra 11.1.6 グラフ・可視化 DiagrammeR DiagrammeRsvg psych summarytools skimr DataExplorer ggsignif patchwork VennDiagram 11.1.7 R Markdown rmarkdown revealjs knitr rmdformats 11.1.8 アプリ Shiny rsconnect shinycssloaders 11.1.9 スクレイピング rvest 11.1.10 Reproducible datapasta 11.1.11 Docker docker liftr install.packages(c( &quot;remotes&quot;, &quot;usethis&quot;, &quot;installr&quot;, &quot;rstudioapi&quot;, &quot;fs&quot;, &quot;eply&quot;, &quot;here&quot;, &quot;BiocManager&quot;, &quot;pacman&quot;, &quot;tidyverse&quot;, &quot;openxlsx&quot;, &quot;dummies&quot;, &quot;data.table&quot;, &quot;tidymodels&quot;, &quot;survival&quot;, &quot;survminer&quot;, &quot;tableone&quot;, &quot;gt&quot;, &quot;gtsummary&quot;, &quot;DT&quot;, &quot;flextable&quot;, &quot;ftExtra&quot;, &quot;DiagrammeR&quot;, &quot;DiagrammeRsvg&quot;, &quot;psych&quot;, &quot;summarytools&quot;, &quot;skimr&quot;, &quot;DataExplorer&quot;, &quot;ggsignif&quot;, &quot;patchwork&quot;, &quot;VennDiagram&quot;, &quot;rmarkdown&quot;, &quot;revealjs&quot;, &quot;knitr&quot;, &quot;rmdformats&quot;, &quot;Shiny&quot;, &quot;rsconnect&quot;, &quot;shinycssloaders&quot;, &quot;rvest&quot;, &quot;datapasta&quot;, &quot;docker&quot;, &quot;liftr&quot; ), dependencies=TRUE) remotes::install_github(&quot;MilesMcBain/breakerofchains&quot;) 11.2 推奨 11.2.1 汎用 devtools reticulate codicR conflicted lintr drake 11.2.2 並列処理 doParallel 11.2.3 R学習 swirl learnr 11.2.4 グラフ ggsci ggrepel GGally officer stargazer myprettyreport corrplot corrr plotly 11.2.5 RStan rstan 11.2.6 LaTeX tinytex 11.2.7 SAS SASmarkdown 11.2.8 疫学 Epi epiR comorbidity icd ggdag 11.2.9 データ分析・機械学習 smartdata bit64 11.2.10 スクレイピング RSelenium 11.2.11 時間計測 tictoc 11.2.12 資料作成 xaringan export INWTlab/ireports remotes::install_github(“INWTlab/ireports”) 11.2.13 アドイン colourPicker colourPicker ggThemeAssist ggplot Theme Assistant styler style active file "],["tips.html", "12 Tips 12.1 R Studioの設定 12.2 ショートカットキー 12.3 # シャープ 12.4 if(0) 12.5 時間計測 12.6 Rの学習・情報を得る 12.7 パッケージの情報を得る 12.8 ググるにあたって 12.9 コーディングスタイルガイド 12.10 Advanced R 12.11 プログラミング時の留意点 12.12 ミスしがちなところ 12.13 メモリ開放 12.14 サンプルデータ作成", " 12 Tips 細かな覚え書き 12.1 R Studioの設定 Windows ~/AppData/Roaming/RStudio/ UNIX ~/.config/rstudio/ rstudio-prefs.json /keybindings/rstudio_bindings.json /keybindings/editor_bindings.json /keybindings/addins.json /snippets/r.snippets 12.2 ショートカットキー https://appsilon.com/rstudio-shortcuts-and-tips/ 動作 キー &lt;- Alt + - %&gt;% Ctrl+Shift+M Rmarkdown knit Ctrl+Shift+K chunk挿入，chunk分割 Ctrl+Shift+I インデント自動揃え Ctrl+I Consoleの+を消す Esc カーソルをスクリプトへ Ctrl+1 カーソルをコンソールへ Ctrl+2 関数自動作成 Ctrl+Alt+X 見出し,チャンクへジャンプ Alt+Shift+J 参考文献 12.3 # シャープ Rスクリプトにコメントを残すには#をつける。 manipulation(df, option = TRUE) # これはコメントです コメントを残すのは、コードレビューしてもらうときのためと、自分が後で見返したときのため。 最初は苦痛かもしれないが、トータルで絶対得なのでコメント書きまくろう。 12.4 if(0) 1行とかの操作を一時的に実行させない場合は上記の#を使えばいい。 実行させたくない操作が多くの行にまたがっている場合は、if(0){}を使うのがおすすめ。 if(0){ veryverylong_action(df) %&gt;% hogehoge(mano = TRUE) %&gt;% tonikaku_nagai_syori() } if(0){}で囲まれたコードは実行されない。実行させたいときはif(1){}とすればよいので、いわばスイッチになる。 12.4.1 パッケージ無かったらインストール if (!require(&quot;dplyr&quot;)) {install.packages(&quot;dplyr&quot;)} 12.4.2 警告を出力せず読み込む suppressWarnings(library(tidyverse)) 12.5 時間計測 12.5.1 tictoc 12.6 Rの学習・情報を得る 12.6.1 ネット R初心者の館 Rによるデータ前処理実習 R関連の情報源 Rクックブック https://www.marketechlabo.com/r-tips/ 12.7 パッケージの情報を得る まずは「パッケージ名+R」で検索し、CRANの公式ドキュメントを見る。英語だがこれを見るのは大事。 githubというサイトにはパッケージの関数がどのように定義されているかが載っているので余力があれば見る。 以下のサイトを使えばGoogle翻訳を駆使して日本語で理解できるかも。 RDocumentation rdrr.io METACRAN 12.8 ググるにあたって わからないことがあったらググる習慣をつけよう。 特に、英語で検索をかけると望みのものが見つかることが多い。 以下に検索に便利なキーワードの書いておく。 知りたいこと キーワード エラーの理由 エラーメッセージコピペ tidy dataから検定したい (検定名) + tidy 12.9 コーディングスタイルガイド tidyverse style guide 12.10 Advanced R Advanced R 第1版 Advanced R 第2版 12.11 プログラミング時の留意点 12.11.1 心がけること 加工前後のデータを比較して、ロジックに問題がないか確認 エラーはあるものと思い、何回も確認 第三者が見ても分かるようにコメントをつける 第三者にコードレビューしてもらう 対象者のフローチャートを書く 12.11.2 できれば行いたいこと 変数定義書を作成 第三者にプログラムを書いてもらい、結果が一致するか確認 12.12 ミスしがちなところ 12.12.1 汎用的なところ タイプミス、スペルミス numeric、character、factor 12.12.2 医療情報データベース特有 年月の差をとるのに普通に引き算 疑いフラグ抜き忘れ 処方日、検査値等の欠損 12.12.3 Rのアップデート 素のRから以下のコードを実行する。 うまくいかない場合は普通にここからダウンロード。 installr::updateR(browse_news = FALSE, install_R = TRUE, copy_packages = FALSE,copy_Rprofile.site = FALSE, keep_old_packages = FALSE, update_packages = TRUE, start_new_R = FALSE,quit_R = TRUE) 12.13 メモリ開放 参考文献 重いデータを読み込んだ時等に、Rの挙動が不安定になったときは以下を実行する。 gc(reset = TRUE) gc(reset = TRUE) 12.14 サンプルデータ作成 12.14.1 data.frame()を使う df &lt;- data.frame(id = c(1,1,2,2,3,3,4,4), value = c(&quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;a&quot;,&quot;b&quot;)) 12.14.2 read.table()を使う df &lt;- read.table(text = &quot;id samediff factor value 1 S give 3 1 S impact 4 2 S give 2 2 S impact 5 3 D give 1 3 D impact 4 4 D give 3 4 D impact 5&quot;, header = TRUE, stringsAsFactors = FALSE) 12.14.3 datapasta "],["テンプレートフォーマット.html", "13 テンプレート・フォーマット 13.1 R Markdown 13.2 ggplot2 13.3 shiny", " 13 テンプレート・フォーマット 13.1 R Markdown 13.1.1 rmdformatsパッケージ robobook bookdownで作ったときと似た感じになる HTML clean template 13.1.2 Rmd to Word https://github.com/INWTlab/ireports 13.2 ggplot2 https://rstudio.github.io/thematic/ 13.3 shiny https://github.com/nanxstats/awesome-shiny-extensions https://github.com/rstudio/bslib https://blog.misw.jp/entry/archives/2821 https://github.com/r4fun/icongram "]]
